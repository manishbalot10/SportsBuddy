<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SportsBuddy</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-ig: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }

        .bg-gradient {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(120, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(255, 0, 128, 0.15) 0%, transparent 50%);
            z-index: 0;
        }

        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 70px;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .logo {
            font-size: 26px;
            font-weight: 800;
            background: var(--gradient-ig);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions { display: flex; gap: 8px; }

        .header-btn {
            width: 44px; height: 44px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            transition: all 0.3s;
        }

        .header-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .header-btn svg { width: 22px; height: 22px; }

        /* View Toggle */
        .view-toggle {
            position: fixed;
            top: 85px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 5px;
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .toggle-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 25px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .toggle-btn.active {
            background: var(--gradient-ig);
            color: white;
        }

        /* Stories */
        .stories-section {
            position: fixed;
            top: 130px; left: 0; right: 0;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(10px);
            z-index: 999;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .stories-scroll {
            display: flex;
            gap: 14px;
            padding: 0 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .stories-scroll::-webkit-scrollbar { display: none; }

        .story-card {
            flex-shrink: 0;
            width: 72px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .story-card:hover { transform: scale(1.05); }

        .story-avatar-wrap {
            width: 60px; height: 60px;
            margin: 0 auto 8px;
            position: relative;
        }

        .story-ring {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: var(--gradient-ig);
        }

        .story-avatar {
            width: 54px; height: 54px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: #ffffff !important;
            border: 3px solid #0a0a0a;
            position: relative;
            z-index: 2;
            margin: 3px;
        }

        .story-name {
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: rgba(255,255,255,0.8);
        }

        /* Map */
        #map {
            position: fixed;
            top: 220px; left: 0; right: 0; bottom: 80px;
            z-index: 1;
        }

        /* Density Bubbles - Snapchat Style */
        .density-bubble {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.3s;
            animation: bubblePulse 3s ease-in-out infinite;
        }

        .density-bubble:hover { transform: scale(1.1); }

        @keyframes bubblePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .density-number {
            font-size: 22px;
            line-height: 1;
        }

        .density-label {
            font-size: 9px;
            font-weight: 600;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Marker styles */
        .marker-inner {
            width: 48px; height: 48px;
            border-radius: 50%;
            padding: 3px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .marker-inner:hover { transform: scale(1.15); }

        .marker-avatar {
            width: 100%; height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            border: 3px solid #0a0a0a;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        /* Cluster */
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
            background: transparent !important;
        }
        .marker-cluster div {
            width: 48px; height: 48px;
            margin-left: -8px; margin-top: -8px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 800;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);
            border: 3px solid rgba(255,255,255,0.4);
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 80px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px 10px;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px 18px;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.3s;
            color: rgba(255,255,255,0.5);
        }
        .nav-item.active { color: #fff; background: var(--glass-bg); }
        .nav-item svg { width: 24px; height: 24px; }
        .nav-item span { font-size: 10px; font-weight: 600; }

        /* City Legend */
        .city-legend {
            position: fixed;
            bottom: 100px;
            left: 16px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 14px;
            z-index: 500;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 200px;
        }

        .legend-title {
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .legend-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
        }

        .location-btn {
            position: fixed;
            bottom: 100px;
            right: 16px;
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            z-index: 500;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .location-btn:hover { transform: scale(1.1); background: var(--gradient-ig); border-color: transparent; }
        .location-btn.loading svg { animation: spin 1s linear infinite; }

        /* Counter */
        .counter-badge {
            position: fixed;
            top: 235px;
            right: 16px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            z-index: 500;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .counter-badge span {
            background: var(--gradient-ig);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Profile Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .profile-card {
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border-radius: 32px 32px 0 0;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-overlay.active .profile-card { transform: translateY(0); }

        .profile-handle {
            width: 40px; height: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            margin: 12px auto;
        }

        .profile-hero {
            height: 140px;
            position: relative;
            overflow: hidden;
        }

        .profile-hero-bg {
            position: absolute;
            inset: 0;
            filter: blur(30px) brightness(0.6);
            transform: scale(1.2);
        }

        .profile-hero-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, transparent 0%, #1a1a1a 100%);
        }

        .profile-avatar-section {
            position: absolute;
            bottom: -45px;
            left: 50%;
            transform: translateX(-50%);
        }

        .profile-avatar-ring {
            width: 100px; height: 100px;
            border-radius: 50%;
            padding: 4px;
            background: var(--gradient-ig);
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }

        .profile-avatar-img {
            width: 100%; height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 800;
            border: 4px solid #1a1a1a;
        }

        .profile-content {
            padding: 55px 24px 28px;
        }

        .profile-name {
            font-size: 26px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 4px;
        }

        .profile-location {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .profile-stats-row {
            display: flex;
            justify-content: center;
            gap: 35px;
            padding: 16px 0;
            margin-bottom: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-box { text-align: center; }
        .stat-value {
            font-size: 20px;
            font-weight: 800;
            background: var(--gradient-3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            margin-top: 3px;
            text-transform: uppercase;
        }

        .profile-sport-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
        }

        .sport-icon-wrap {
            width: 55px; height: 55px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .sport-info h4 { font-size: 17px; font-weight: 700; margin-bottom: 4px; }

        .level-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .level-beginner { background: linear-gradient(135deg, #374151, #1f2937); }
        .level-intermediate { background: linear-gradient(135deg, #1e40af, #1e3a8a); }
        .level-advanced { background: linear-gradient(135deg, #059669, #047857); }
        .level-professional { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .level-state { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
        .level-national { background: linear-gradient(135deg, #db2777, #be185d); }
        .level-district { background: linear-gradient(135deg, #0891b2, #0e7490); }

        .profile-actions { display: flex; gap: 10px; }

        .btn-primary {
            flex: 1;
            padding: 14px;
            background: var(--gradient-ig);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary:hover { transform: translateY(-2px); }

        .btn-secondary {
            flex: 1;
            padding: 14px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
        }

        .close-btn {
            position: absolute;
            top: 16px; right: 16px;
            width: 36px; height: 36px;
            background: rgba(0,0,0,0.5);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
        }

        /* Search */
        .search-modal {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-modal.active { transform: translateX(0); }

        .search-header {
            display: flex;
            align-items: center;
            padding: 14px;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .search-back {
            width: 42px; height: 42px;
            background: var(--glass-bg);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-input-wrap {
            flex: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 11px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input-wrap input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: white;
            font-size: 15px;
            font-family: inherit;
        }
        .search-input-wrap input::placeholder { color: rgba(255,255,255,0.3); }

        .search-results {
            padding: 14px;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
        }

        .result-card {
            display: flex;
            align-items: center;
            padding: 12px;
            gap: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .result-card:hover { background: rgba(255,255,255,0.15); transform: translateX(6px); }

        .result-avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .result-info { flex: 1; }
        .result-name { font-weight: 700; font-size: 15px; margin-bottom: 3px; }
        .result-detail { font-size: 12px; color: rgba(255,255,255,0.5); }

        /* Loading */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }

        .loading-logo {
            font-size: 36px;
            font-weight: 800;
            background: var(--gradient-ig);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
        }

        .loading-spinner {
            width: 45px; height: 45px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #f5576c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            margin-top: 18px;
            color: rgba(255,255,255,0.5);
            font-size: 14px;
        }

        /* Filter Modal */
        .filter-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s;
            display: flex;
            align-items: flex-end;
        }
        .filter-modal.active { opacity: 1; visibility: visible; }

        .filter-sheet {
            width: 100%;
            max-height: 75vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border-radius: 28px 28px 0 0;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }
        .filter-modal.active .filter-sheet { transform: translateY(0); }

        .filter-header {
            text-align: center;
            padding: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .filter-handle {
            width: 36px; height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 0 auto 14px;
        }

        .filter-title { font-size: 18px; font-weight: 700; }

        .filter-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .filter-section-title {
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
        }

        .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; }

        .filter-chip {
            padding: 10px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-chip:hover { background: rgba(255,255,255,0.15); }
        .filter-chip.active { background: var(--gradient-ig); border-color: transparent; }

        .filter-apply-btn {
            margin: 20px;
            padding: 16px;
            background: var(--gradient-ig);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            width: calc(100% - 40px);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <div class="loading-screen" id="loading">
        <div class="loading-logo">SportsBuddy</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Discovering players near you...</div>
    </div>

    <header class="header">
        <div class="logo">SportsBuddy</div>
        <div class="header-actions">
            <button class="header-btn" id="searchBtn">
                <svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
            </button>
            <button class="header-btn" id="filterBtn">
                <svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path d="M3 6h18M7 12h10M10 18h4"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- View Toggle -->
    <div class="view-toggle">
        <button class="toggle-btn active" id="toggleMarkers">üë• Players</button>
        <button class="toggle-btn" id="toggleDensity">üî• Hotspots</button>
    </div>

    <section class="stories-section">
        <div class="stories-scroll" id="storiesScroll"></div>
    </section>

    <div class="counter-badge" onclick="resetFilters()" style="cursor: pointer;">
        <span id="count">1000</span> players ‚Üª
    </div>

    <div class="city-legend" id="cityLegend" style="display: none;">
        <div class="legend-title">Player Density</div>
        <div class="legend-item"><div class="legend-dot" style="background: #22c55e;"></div> 1-20 players</div>
        <div class="legend-item"><div class="legend-dot" style="background: #eab308;"></div> 21-50 players</div>
        <div class="legend-item"><div class="legend-dot" style="background: #f97316;"></div> 51-100 players</div>
        <div class="legend-item"><div class="legend-dot" style="background: #ef4444;"></div> 100+ players</div>
    </div>

    <button class="location-btn" id="myLocationBtn" title="My Location">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
            <path d="M12 2a10 10 0 1 0 10 10 10 10 0 0 0-10-10zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/>
            <path d="M12 17a5 5 0 1 0-5-5 5 5 0 0 0 5 5z"/>
        </svg>
    </button>

    <div id="map"></div>

    <nav class="bottom-nav">
        <div class="nav-item active">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                <circle cx="12" cy="9" r="2.5"/>
            </svg>
            <span>Discover</span>
        </div>
        <div class="nav-item">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <rect x="3" y="3" width="7" height="7" rx="1"/>
                <rect x="14" y="3" width="7" height="7" rx="1"/>
                <rect x="3" y="14" width="7" height="7" rx="1"/>
                <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
            <span>Explore</span>
        </div>
        <div class="nav-item">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <span>Connect</span>
        </div>
        <div class="nav-item">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            <span>Settings</span>
        </div>
    </nav>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <button class="close-btn" id="closeProfile">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M18 6 6 18M6 6l12 12"/>
            </svg>
        </button>
        <div class="profile-card">
            <div class="profile-handle"></div>
            <div class="profile-hero">
                <div class="profile-hero-bg" id="profileHeroBg"></div>
                <div class="profile-hero-gradient"></div>
                <div class="profile-avatar-section">
                    <div class="profile-avatar-ring">
                        <div class="profile-avatar-img" id="profileAvatar">RS</div>
                    </div>
                </div>
            </div>
            <div class="profile-content">
                <h2 class="profile-name" id="profileName">Rahul Sharma</h2>
                <div class="profile-location">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                    </svg>
                    <span id="profileCity">Mumbai, India</span>
                </div>
                <div class="profile-stats-row">
                    <div class="stat-box">
                        <div class="stat-value" id="profileLat">19.07¬∞</div>
                        <div class="stat-label">Lat</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="profileLng">72.87¬∞</div>
                        <div class="stat-label">Lng</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="profileId">#001</div>
                        <div class="stat-label">ID</div>
                    </div>
                </div>
                <div class="profile-sport-card">
                    <div class="sport-icon-wrap" id="sportIconWrap">üèè</div>
                    <div class="sport-info">
                        <h4 id="profileSport">Cricket</h4>
                        <span class="level-badge" id="profileLevel">Professional</span>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="btn-primary">ü§ù Connect</button>
                    <button class="btn-secondary">üí¨ Message</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-header">
            <button class="search-back" id="searchBack">
                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
            </button>
            <div class="search-input-wrap">
                <svg width="18" height="18" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Search players, sports, cities...">
            </div>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- Filter Modal -->
    <div class="filter-modal" id="filterModal">
        <div class="filter-sheet">
            <div class="filter-header">
                <div class="filter-handle"></div>
                <div class="filter-title">Filters</div>
            </div>
            <div class="filter-section">
                <div class="filter-section-title">Sport</div>
                <div class="filter-chips" id="sportChips"></div>
            </div>
            <div class="filter-section">
                <div class="filter-section-title">Level</div>
                <div class="filter-chips" id="levelChips"></div>
            </div>
            <div class="filter-section">
                <div class="filter-section-title">City</div>
                <div class="filter-chips" id="cityChips"></div>
            </div>
            <button class="filter-apply-btn" id="applyFilter">Show Results</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        const sportConfig = {
            'Cricket': { color: '#3b82f6', gradient: 'linear-gradient(135deg, #667eea, #764ba2)', icon: 'üèè' },
            'Football': { color: '#22c55e', gradient: 'linear-gradient(135deg, #43e97b, #38f9d7)', icon: '‚öΩ' },
            'Hockey': { color: '#f97316', gradient: 'linear-gradient(135deg, #f093fb, #f5576c)', icon: 'üèë' },
            'Badminton': { color: '#8b5cf6', gradient: 'linear-gradient(135deg, #667eea, #764ba2)', icon: 'üè∏' },
            'Tennis': { color: '#eab308', gradient: 'linear-gradient(135deg, #fa709a, #fee140)', icon: 'üéæ' },
            'Table Tennis': { color: '#ec4899', gradient: 'linear-gradient(135deg, #f093fb, #f5576c)', icon: 'üèì' },
            'Kabaddi': { color: '#ef4444', gradient: 'linear-gradient(135deg, #ff416c, #ff4b2b)', icon: 'ü§º' },
            'Wrestling': { color: '#dc2626', gradient: 'linear-gradient(135deg, #ff416c, #ff4b2b)', icon: 'ü§º‚Äç‚ôÇÔ∏è' },
            'Boxing': { color: '#b91c1c', gradient: 'linear-gradient(135deg, #ff416c, #ff4b2b)', icon: 'ü•ä' },
            'Shooting': { color: '#6b7280', gradient: 'linear-gradient(135deg, #536976, #292e49)', icon: 'üéØ' },
            'Archery': { color: '#84cc16', gradient: 'linear-gradient(135deg, #43e97b, #38f9d7)', icon: 'üèπ' },
            'Athletics': { color: '#14b8a6', gradient: 'linear-gradient(135deg, #4facfe, #00f2fe)', icon: 'üèÉ' },
            'Swimming': { color: '#06b6d4', gradient: 'linear-gradient(135deg, #4facfe, #00f2fe)', icon: 'üèä' },
            'Volleyball': { color: '#f59e0b', gradient: 'linear-gradient(135deg, #fa709a, #fee140)', icon: 'üèê' },
            'Basketball': { color: '#f97316', gradient: 'linear-gradient(135deg, #f093fb, #f5576c)', icon: 'üèÄ' },
            'Chess': { color: '#475569', gradient: 'linear-gradient(135deg, #536976, #292e49)', icon: '‚ôüÔ∏è' },
            'Carrom': { color: '#92400e', gradient: 'linear-gradient(135deg, #c79081, #dfa579)', icon: 'üéØ' },
            'Kho Kho': { color: '#7c3aed', gradient: 'linear-gradient(135deg, #667eea, #764ba2)', icon: 'üèÉ‚Äç‚ôÄÔ∏è' },
            'Squash': { color: '#0891b2', gradient: 'linear-gradient(135deg, #4facfe, #00f2fe)', icon: 'üéæ' },
            'Golf': { color: '#16a34a', gradient: 'linear-gradient(135deg, #43e97b, #38f9d7)', icon: '‚õ≥' },
            'Cycling': { color: '#2563eb', gradient: 'linear-gradient(135deg, #667eea, #764ba2)', icon: 'üö¥' },
            'Weightlifting': { color: '#7c2d12', gradient: 'linear-gradient(135deg, #c79081, #dfa579)', icon: 'üèãÔ∏è' },
            'Gymnastics': { color: '#db2777', gradient: 'linear-gradient(135deg, #f093fb, #f5576c)', icon: 'ü§∏' },
            'Martial Arts': { color: '#991b1b', gradient: 'linear-gradient(135deg, #ff416c, #ff4b2b)', icon: 'ü•ã' },
            'Yoga': { color: '#059669', gradient: 'linear-gradient(135deg, #43e97b, #38f9d7)', icon: 'üßò' },
            'Running': { color: '#0d9488', gradient: 'linear-gradient(135deg, #4facfe, #00f2fe)', icon: 'üèÉ' },
            'Marathon': { color: '#0f766e', gradient: 'linear-gradient(135deg, #4facfe, #00f2fe)', icon: 'üèÉ‚Äç‚ôÇÔ∏è' },
            'Throwball': { color: '#c026d3', gradient: 'linear-gradient(135deg, #f093fb, #f5576c)', icon: 'ü§æ' },
            'Handball': { color: '#9333ea', gradient: 'linear-gradient(135deg, #667eea, #764ba2)', icon: 'ü§æ‚Äç‚ôÇÔ∏è' },
            'Baseball': { color: '#dc2626', gradient: 'linear-gradient(135deg, #ff416c, #ff4b2b)', icon: '‚öæ' }
        };

        const levelClasses = {
            'Beginner': 'level-beginner',
            'Intermediate': 'level-intermediate',
            'Advanced': 'level-advanced',
            'Professional': 'level-professional',
            'State Level': 'level-state',
            'National Level': 'level-national',
            'District Level': 'level-district'
        };

        let map, markers, heatLayer, densityMarkers = [];
        let allPeople = [], filteredPeople = [];
        let currentView = 'markers';

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([20.5937, 78.9629], 5);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap ¬© CARTO',
                maxZoom: 19
            }).addTo(map);

            markers = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 60,
                iconCreateFunction: cluster => L.divIcon({
                    html: `<div>${cluster.getChildCount()}</div>`,
                    className: 'marker-cluster',
                    iconSize: L.point(48, 48)
                })
            });
            map.addLayer(markers);
        }

        function createMarker(person) {
            const cfg = sportConfig[person.sport] || { color: '#6b7280', gradient: 'linear-gradient(135deg, #536976, #292e49)', icon: 'üèÖ' };
            const initials = person.name.split(' ').map(n => n[0]).join('');

            const icon = L.divIcon({
                className: '',
                html: `<div class="marker-inner" style="background: ${cfg.gradient}">
                    <div class="marker-avatar" style="background: ${cfg.color}">${initials}</div>
                </div>`,
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });

            const marker = L.marker([person.latitude, person.longitude], { icon });
            marker.on('click', () => showProfile(person));
            return marker;
        }

        // Calculate city density and create Snapchat-style bubbles
        function calculateDensity() {
            const cityCount = {};
            const cityCoords = {};

            filteredPeople.forEach(p => {
                if (!cityCount[p.city]) {
                    cityCount[p.city] = 0;
                    cityCoords[p.city] = { lat: 0, lng: 0 };
                }
                cityCount[p.city]++;
                cityCoords[p.city].lat += p.latitude;
                cityCoords[p.city].lng += p.longitude;
            });

            // Average coordinates for each city
            Object.keys(cityCoords).forEach(city => {
                cityCoords[city].lat /= cityCount[city];
                cityCoords[city].lng /= cityCount[city];
            });

            return { cityCount, cityCoords };
        }

        function getDensityColor(count) {
            if (count > 100) return { bg: 'linear-gradient(135deg, #ef4444, #dc2626)', color: '#ef4444' };
            if (count > 50) return { bg: 'linear-gradient(135deg, #f97316, #ea580c)', color: '#f97316' };
            if (count > 20) return { bg: 'linear-gradient(135deg, #eab308, #ca8a04)', color: '#eab308' };
            return { bg: 'linear-gradient(135deg, #22c55e, #16a34a)', color: '#22c55e' };
        }

        function getDensitySize(count) {
            if (count > 100) return 80;
            if (count > 50) return 70;
            if (count > 20) return 60;
            return 50;
        }

        function showDensityView() {
            currentView = 'density';
            map.removeLayer(markers);
            
            // Clear existing density markers
            densityMarkers.forEach(m => map.removeLayer(m));
            densityMarkers = [];

            const { cityCount, cityCoords } = calculateDensity();

            // Create Snapchat-style density bubbles
            Object.keys(cityCount).forEach(city => {
                const count = cityCount[city];
                const coords = cityCoords[city];
                const colors = getDensityColor(count);
                const size = getDensitySize(count);

                const icon = L.divIcon({
                    className: '',
                    html: `
                        <div class="density-bubble" style="
                            width: ${size}px;
                            height: ${size}px;
                            background: ${colors.bg};
                        ">
                            <span class="density-number">${count}</span>
                            <span class="density-label">players</span>
                        </div>
                    `,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });

                const marker = L.marker([coords.lat, coords.lng], { icon });
                marker.on('click', () => {
                    // Just zoom into the city without filtering
                    map.setView([coords.lat, coords.lng], 11);
                });
                
                marker.addTo(map);
                densityMarkers.push(marker);
            });

            // Create heatmap layer
            const heatData = filteredPeople.map(p => [p.latitude, p.longitude, 0.5]);
            if (heatLayer) map.removeLayer(heatLayer);
            heatLayer = L.heatLayer(heatData, {
                radius: 35,
                blur: 25,
                maxZoom: 10,
                gradient: {
                    0.2: '#22c55e',
                    0.4: '#eab308',
                    0.6: '#f97316',
                    0.8: '#ef4444',
                    1.0: '#dc2626'
                }
            }).addTo(map);

            document.getElementById('cityLegend').style.display = 'block';
            document.getElementById('toggleDensity').classList.add('active');
            document.getElementById('toggleMarkers').classList.remove('active');
        }

        function showMarkersView() {
            currentView = 'markers';
            
            // Remove heatmap and density markers
            if (heatLayer) map.removeLayer(heatLayer);
            densityMarkers.forEach(m => map.removeLayer(m));
            densityMarkers = [];

            // Show clustered markers
            markers.clearLayers();
            filteredPeople.forEach(p => markers.addLayer(createMarker(p)));
            map.addLayer(markers);

            document.getElementById('cityLegend').style.display = 'none';
            document.getElementById('toggleMarkers').classList.add('active');
            document.getElementById('toggleDensity').classList.remove('active');
        }

        async function loadData() {
            const res = await fetch('people_india_sports.json');
            allPeople = await res.json();
            filteredPeople = [...allPeople];
            showMarkersView();
            populateStories();
            populateFilters();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('count').textContent = filteredPeople.length;
        }

        function populateStories() {
            const scroll = document.getElementById('storiesScroll');
            scroll.innerHTML = filteredPeople.slice(0, 20).map(p => {
                const cfg = sportConfig[p.sport] || { color: '#6b7280', icon: 'üèÖ' };
                const initials = p.name.split(' ').map(n => n[0]).join('');
                return `
                    <div class="story-card" onclick="showProfile(allPeople.find(x => x.id === ${p.id}))">
                        <div class="story-avatar-wrap">
                            <div class="story-ring"></div>
                            <div class="story-avatar" style="background: ${cfg.color}">${initials}</div>
                        </div>
                        <div class="story-name">${p.name.split(' ')[0]}</div>
                    </div>`;
            }).join('');
        }

        function populateFilters() {
            const sports = [...new Set(allPeople.map(p => p.sport))].sort();
            const levels = [...new Set(allPeople.map(p => p.level))];
            const cities = [...new Set(allPeople.map(p => p.city))].sort();

            document.getElementById('sportChips').innerHTML = `<div class="filter-chip active" data-v="">All</div>` +
                sports.slice(0, 10).map(s => `<div class="filter-chip" data-v="${s}">${sportConfig[s]?.icon || 'üèÖ'} ${s}</div>`).join('');

            document.getElementById('levelChips').innerHTML = `<div class="filter-chip active" data-v="">All</div>` +
                levels.map(l => `<div class="filter-chip" data-v="${l}">${l}</div>`).join('');

            document.getElementById('cityChips').innerHTML = `<div class="filter-chip active" data-v="">All</div>` +
                cities.map(c => `<div class="filter-chip" data-v="${c}">${c}</div>`).join('');

            document.querySelectorAll('.filter-chips').forEach(container => {
                container.addEventListener('click', e => {
                    if (e.target.classList.contains('filter-chip')) {
                        container.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                    }
                });
            });
        }

        function showProfile(p) {
            const cfg = sportConfig[p.sport] || { color: '#6b7280', gradient: 'linear-gradient(135deg, #536976, #292e49)', icon: 'üèÖ' };
            const initials = p.name.split(' ').map(n => n[0]).join('');

            document.getElementById('profileAvatar').textContent = initials;
            document.getElementById('profileAvatar').style.background = cfg.color;
            document.getElementById('profileHeroBg').style.background = cfg.gradient;
            document.getElementById('profileName').textContent = p.name;
            document.getElementById('profileCity').textContent = `${p.city}, India`;
            document.getElementById('profileLat').textContent = `${p.latitude.toFixed(2)}¬∞`;
            document.getElementById('profileLng').textContent = `${p.longitude.toFixed(2)}¬∞`;
            document.getElementById('profileId').textContent = `#${String(p.id).padStart(3, '0')}`;
            document.getElementById('sportIconWrap').textContent = cfg.icon;
            document.getElementById('sportIconWrap').style.background = cfg.gradient;
            document.getElementById('profileSport').textContent = p.sport;
            document.getElementById('profileLevel').textContent = p.level;
            document.getElementById('profileLevel').className = `level-badge ${levelClasses[p.level] || ''}`;

            document.getElementById('profileModal').classList.add('active');
        }

        function search(q) {
            const results = allPeople.filter(p =>
                p.name.toLowerCase().includes(q.toLowerCase()) ||
                p.sport.toLowerCase().includes(q.toLowerCase()) ||
                p.city.toLowerCase().includes(q.toLowerCase())
            ).slice(0, 20);

            document.getElementById('searchResults').innerHTML = results.map(p => {
                const cfg = sportConfig[p.sport] || { color: '#6b7280', icon: 'üèÖ' };
                const initials = p.name.split(' ').map(n => n[0]).join('');
                return `
                    <div class="result-card" onclick="showProfile(allPeople.find(x => x.id === ${p.id})); closeSearch();">
                        <div class="result-avatar" style="background: ${cfg.color}">${initials}</div>
                        <div class="result-info">
                            <div class="result-name">${p.name}</div>
                            <div class="result-detail">${cfg.icon} ${p.sport} ‚Ä¢ ${p.level} ‚Ä¢ ${p.city}</div>
                        </div>
                    </div>`;
            }).join('');
        }

        function applyFilters() {
            const sport = document.querySelector('#sportChips .active')?.dataset.v || '';
            const level = document.querySelector('#levelChips .active')?.dataset.v || '';
            const city = document.querySelector('#cityChips .active')?.dataset.v || '';

            filteredPeople = allPeople.filter(p =>
                (!sport || p.sport === sport) &&
                (!level || p.level === level) &&
                (!city || p.city === city)
            );

            if (currentView === 'markers') {
                showMarkersView();
            } else {
                showDensityView();
            }
            populateStories();
            document.getElementById('count').textContent = filteredPeople.length;
            closeFilter();
        }

        const closeProfile = () => document.getElementById('profileModal').classList.remove('active');
        const openSearch = () => { document.getElementById('searchModal').classList.add('active'); document.getElementById('searchInput').focus(); };
        const closeSearch = () => document.getElementById('searchModal').classList.remove('active');
        const openFilter = () => document.getElementById('filterModal').classList.add('active');
        
        function resetFilters() {
            filteredPeople = [...allPeople];
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.filter-chip[data-v=""]').forEach(c => c.classList.add('active'));
            if (currentView === 'markers') showMarkersView();
            else showDensityView();
            populateStories();
            document.getElementById('count').textContent = filteredPeople.length;
            map.setView([20.5937, 78.9629], 5);
        }
        const closeFilter = () => document.getElementById('filterModal').classList.remove('active');

        document.getElementById('closeProfile').onclick = closeProfile;
        document.getElementById('profileModal').onclick = e => { if (e.target.id === 'profileModal') closeProfile(); };
        document.getElementById('searchBtn').onclick = openSearch;
        document.getElementById('searchBack').onclick = closeSearch;
        document.getElementById('searchInput').oninput = e => search(e.target.value);
        document.getElementById('filterBtn').onclick = openFilter;
        document.getElementById('filterModal').onclick = e => { if (e.target.id === 'filterModal') closeFilter(); };
        document.getElementById('applyFilter').onclick = applyFilters;

        document.getElementById('toggleMarkers').onclick = showMarkersView;
        document.getElementById('toggleDensity').onclick = showDensityView;

        // My Location Logic
        document.getElementById('myLocationBtn').onclick = () => {
            const btn = document.getElementById('myLocationBtn');
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            btn.classList.add('loading');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    map.flyTo([latitude, longitude], 13, {
                        animate: true,
                        duration: 1.5
                    });
                    
                    // Add current location marker
                    L.marker([latitude, longitude], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<div style="width: 16px; height: 16px; background: #3b82f6; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);"></div>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).addTo(map)
                    .bindPopup('You are here')
                    .openPopup();

                    btn.classList.remove('loading');
                },
                (error) => {
                    console.error('Error getting location:', error);
                    alert('Unable to retrieve your location. Please check your settings.');
                    btn.classList.remove('loading');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        };

        initMap();
        loadData();
    </script>
</body>
</html>
